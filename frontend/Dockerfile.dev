# ğŸ—ï¸ Use Node.js Alpine to keep the image lightweight and optimized
FROM node:20-alpine AS dev

# ğŸ”¹ Startup message for the build process
RUN echo "âœ… Starting Vite.js container setup..."

# ğŸ“‚ Set the working directory where the source code will reside
WORKDIR /app
RUN echo "ğŸ“‚ Working directory set to /app"

# DependÃªncias necessÃ¡rias para build de canvas
RUN apk add --no-cache python3 make g++ pkgconfig cairo-dev pango-dev jpeg-dev giflib-dev && \
    ln -sf /usr/bin/python3 /usr/bin/python

# ğŸ“¦ Copy essential files first to optimize Docker cache
RUN echo "ğŸ“¦ Copying essential files to optimize Docker cache..."
COPY package.json yarn.lock ./

# ğŸ§¹ Clean Yarn cache before installing dependencies to ensure a clean environment
RUN echo "ğŸ§¹ Cleaning old Yarn cache..."
RUN yarn cache clean && echo "âœ… Yarn cache cleaned successfully!"

# ğŸ“¦ Install dependencies with optimizations, ignoring engine restrictions
RUN echo "ğŸ”„ Installing dependencies with cache optimizations and ignoring engine constraints..."
RUN yarn install --ignore-engines --prefer-offline --frozen-lockfile
RUN echo "âœ… All dependencies installed successfully!"

# ğŸ“‚ Copy the entire project source into the container
RUN echo "ğŸ“‚ Copying source code into the container..."
COPY . .
RUN echo "âœ… Source code copied successfully!"

# ğŸ—‘ï¸ Remove unnecessary files to keep the image small
RUN echo "ğŸ—‘ï¸  Removing unnecessary files before build..."
RUN rm -rf /app/dist /app/node_modules
RUN echo "âœ… Unnecessary files removed successfully!"

# ğŸŒ Set environment variables and configure the Vite.js port
ARG VITE_PORT=3000
ENV VITE_PORT=${VITE_PORT}

# ğŸŒ Expose the port for Vite.js dev server
RUN echo "ğŸŒ Exposing port ${VITE_PORT} for frontend access..."
EXPOSE ${VITE_PORT}
RUN echo "âœ… Port ${VITE_PORT} configured successfully!"

# ğŸš€ Final message before launching the server
RUN echo "ğŸš€ Development environment is ready! Launching Vite.js with Hot Reload..."

# ğŸ Default command to run in development mode with Hot Reload
CMD ["yarn", "dev"]
