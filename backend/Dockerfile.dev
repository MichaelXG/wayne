# Usa Python 3.11-slim como base para reduzir o tamanho da imagem
FROM python:3.11-slim

# ğŸ“‚ Define o diretÃ³rio de trabalho no contÃªiner onde o cÃ³digo-fonte serÃ¡ armazenado e executado
RUN echo "ğŸ“‚ Definindo o diretÃ³rio de trabalho como /app dentro do contÃªiner..."
WORKDIR /app
RUN echo "âœ… DiretÃ³rio de trabalho definido com sucesso!"

# ğŸ”„ Atualiza pacotes do sistema e instala dependÃªncias essenciais
RUN echo "ğŸ“¦ Iniciando atualizaÃ§Ã£o dos pacotes do sistema..." 
RUN apt-get update 
RUN echo "âœ… Pacotes do sistema atualizados com sucesso!"

# Exibe uma mensagem informando que a instalaÃ§Ã£o das dependÃªncias estÃ¡ iniciando
RUN echo "ğŸ“¦ Instalando pacotes essenciais: curl, sqlite3, dos2unix, python3-venv, procps..."

RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    sqlite3 \
    dos2unix \
    python3-venv \
    procps 

# Exibe uma mensagem informando que a limpeza de pacotes desnecessÃ¡rios estÃ¡ iniciando
RUN echo "ğŸ§¹ Limpando pacotes desnecessÃ¡rios para reduzir o tamanho da imagem..."
RUN apt-get clean 

# Exibe uma mensagem informando que a remoÃ§Ã£o de arquivos temporÃ¡rios estÃ¡ sendo feita
RUN echo "ğŸ—‘ï¸ Removendo arquivos temporÃ¡rios do gerenciador de pacotes..."
RUN rm -rf /var/lib/apt/lists/*

# Confirma que todos os pacotes foram instalados com sucesso
RUN echo "âœ… Todos os pacotes foram instalados e otimizados com sucesso!"

# Copia o arquivo de dependÃªncias para o diretÃ³rio do aplicativo no container
COPY requirements.txt /app/
RUN echo "ğŸ“‚ Arquivo requirements.txt copiado com sucesso!"

# Copia o arquivo .env para o diretÃ³rio do aplicativo, se existir
RUN echo "ğŸ” Verificando a existÃªncia do arquivo .env..."
COPY .env /app/.env

# Converte o .env para o formato UNIX para evitar problemas de compatibilidade
RUN if [ -f "/app/.env" ]; then \
    echo "âœ… Arquivo .env encontrado! Convertendo para formato UNIX..."; \
    dos2unix /app/.env || true; \
    echo "âœ… ConversÃ£o concluÃ­da com sucesso!"; \
    else \
    echo "âš ï¸  Aviso: Arquivo .env nÃ£o encontrado! Continuando sem conversÃ£o."; \
    fi

# Exibe uma mensagem indicando o inÃ­cio da instalaÃ§Ã£o das dependÃªncias do Python
RUN echo "ğŸ“¦ Iniciando a instalaÃ§Ã£o das dependÃªncias do projeto..."

# Atualiza o gerenciador de pacotes do Python e ferramentas essenciais
RUN echo "ğŸ”„ Atualizando pip, setuptools e wheel..."
RUN pip install --no-cache-dir --upgrade pip setuptools wheel

# Instala as dependÃªncias do projeto com estratÃ©gia otimizada para resolver dependÃªncias mais rapidamente
RUN echo "ğŸš€ Instalando dependÃªncias do projeto a partir do arquivo requirements.txt..."
RUN pip install --no-cache-dir --upgrade-strategy eager -r /app/requirements.txt --timeout=1000 

# Confirma que todas as dependÃªncias foram instaladas corretamente
RUN echo "âœ… Todas as dependÃªncias foram instaladas com sucesso!"

# Copia o restante do cÃ³digo do projeto
COPY . /app/
RUN echo "âœ… CÃ³digo-fonte copiado!"

# Copia o script de entrada para o diretÃ³rio /app dentro do container
RUN echo "ğŸ“‚ Copiando o script entrypoint.sh para o diretÃ³rio do aplicativo..."
COPY entrypoint.sh /app/entrypoint.sh

# Ajusta as permissÃµes do script para garantir que ele seja executÃ¡vel
RUN echo "ğŸ”’ Ajustando permissÃµes de execuÃ§Ã£o para entrypoint.sh..."
RUN chmod +x /app/entrypoint.sh 

# Confirma que as permissÃµes foram ajustadas corretamente
RUN echo "âœ… PermissÃµes aplicadas com sucesso para entrypoint.sh!"

# ExpÃµe a porta 8000 para permitir acesso ao servidor Django dentro do container
RUN echo "ğŸŒ Configurando a porta 8000 para comunicaÃ§Ã£o com o backend..."
EXPOSE 8000

# Exibe uma mensagem final confirmando que o container estÃ¡ pronto para ser iniciado
RUN echo "ğŸš€ Docker container configurado com sucesso e pronto para execuÃ§Ã£o!"

# Define o comando de entrada do container usando Bash para compatibilidade com o entrypoint.sh
RUN echo "ğŸ› ï¸ Configurando o entrypoint para executar o script corretamente..."
CMD ["/bin/bash", "/app/entrypoint.sh"]
