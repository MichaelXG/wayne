# âœ… Usa Python 3.11-slim como base
FROM python:3.11-slim

# âœ… Define o diretÃ³rio de trabalho
WORKDIR /app
RUN echo "ğŸ“‚ DiretÃ³rio de trabalho definido como /app"

# âœ… Atualiza pacotes e instala dependÃªncias essenciais
RUN echo "ğŸ“¦ Atualizando pacotes e instalando dependÃªncias..." && \
    apt-get update && \
    apt-get install -y --no-install-recommends \
        curl \
        sqlite3 \
        dos2unix \
        python3-venv \
        procps && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* && \
    echo "âœ… DependÃªncias do sistema instaladas!"

# âœ… Copia arquivos essenciais
COPY requirements.txt /app/
COPY .env /app/.env
COPY entrypoint.sh /app/
COPY . /app/

# âœ… Ajusta permissÃµes e converte arquivos
RUN echo "ğŸ”’ Ajustando permissÃµes e convertendo arquivos..." && \
    chmod -R 755 /app && \
    for f in .env entrypoint.sh; do \
        if [ -f "/app/$f" ]; then \
            echo "âœ… $f encontrado! Convertendo para UNIX..."; \
            dos2unix "/app/$f" || true; \
            [ "$f" = "entrypoint.sh" ] && chmod +x "/app/$f"; \
            echo "âœ… $f pronto!"; \
        else \
            echo "âš ï¸ $f nÃ£o encontrado!"; \
        fi; \
    done

# âœ… Atualiza pip, setuptools e wheel
RUN echo "ğŸ”„ Atualizando pip, setuptools e wheel..." && \
    pip install --no-cache-dir --upgrade pip setuptools wheel

# âœ… Instala dependÃªncias Python
RUN echo "ğŸš€ Instalando dependÃªncias do projeto..." && \
    pip install --no-cache-dir --upgrade-strategy eager -r /app/requirements.txt --timeout=1000 && \
    echo "âœ… DependÃªncias Python instaladas com sucesso!"

# âœ… Expondo porta padrÃ£o
EXPOSE 8000
RUN echo "ğŸŒ Porta 8000 exposta para o backend!"

# âœ… Confirma finalizaÃ§Ã£o da configuraÃ§Ã£o
RUN echo "ğŸš€ Docker container configurado com sucesso e pronto para execuÃ§Ã£o!"

# âœ… Define o comando padrÃ£o de execuÃ§Ã£o
# Para ambiente de desenvolvimento, descomente a linha abaixo:
# CMD ["/bin/bash", "/app/entrypoint.sh"]

# Para ambiente de produÃ§Ã£o, com Gunicorn:
CMD ["gunicorn", "-b", "0.0.0.0:8000", "wayne_backend.wsgi:application", "--workers=3", "--timeout=120"]
